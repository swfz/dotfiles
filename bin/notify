#!/bin/bash

_usage(){
cat << EOS
usage:
  ./notify title prompt

script notification to windows from wsl

require environment
  POWERSHELL_EXE   path of powershell.exe as seen from wsl
    e.g.) /mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe
  NOTIFY_PS1       path of nitofy.ps1(notification script) as seen from Windows
    e.g.) c:/Users/hoge/Desktop/notify.ps1
EOS
  exit 1
}


if [ -z ${POWERSHELL_EXE} ]; then
  echo 'require environment variable POWERSHELL_EXE that contains powershell.exe path.'
  _usage
fi

if [ -z ${NOTIFY_PS1} ]; then
  echo 'require environment variable NOTIFY_PS1 that contains notify.ps2 path.'
  _usage
fi

DEFAULT_TITLE="WSL Notification"
DEFAULT_MESSAGE="Task Completed"

PIPE_INPUT=""

if [ -p /dev/stdin ]; then
  PIPE_INPUT=$(cat)
fi

if [ -n "$PIPE_INPUT" ]; then
  # Usage: echo "Done" | notify "title text"
  TITLE="${1:-$DEFAULT_TITLE}"
  MESSAGE="$PIPE_INPUT"
else
  # Usage: notify "title text" "message"
  # Usage: notify "message"
  if [ $# -eq 1 ]; then
    TITLE="$DEFAULT_TITLE"
    MESSAGE="$1"
  else
    TITLE="${1:-$DEFAULT_TITLE}"
    MESSAGE="${2:-$DEFAULT_MESSAGE}"
  fi
fi

CLEAN_MESSAGE=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g')
CLEAN_TITLE=$(echo "$TITLE" | sed 's/"/\\"/g')

${POWERSHELL_EXE} -Sta -NoProfile -WindowStyle Hidden -ExecutionPolicy RemoteSigned -File ${NOTIFY_PS1} -Title ${CLEAN_TITLE} -Prompt ${CLEAN_MESSAGE}

