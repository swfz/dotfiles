#!/bin/bash

OS_TYPE="$(uname -s)"

_usage(){
cat << EOS
usage:
  notify title message
  notify message
  echo "message" | notify title

send desktop notifications (supports macOS and WSL)

on WSL, requires environment variables:
  POWERSHELL_EXE   path of powershell.exe as seen from wsl
  NOTIFY_PS1       path of notify.ps1(notification script) as seen from Windows

on macOS, no additional configuration is needed.
EOS
  exit 1
}

if [ "$OS_TYPE" = "Linux" ]; then
  if [ -z "${POWERSHELL_EXE}" ]; then
    echo 'require environment variable POWERSHELL_EXE that contains powershell.exe path.'
    _usage
  fi
  if [ -z "${NOTIFY_PS1}" ]; then
    echo 'require environment variable NOTIFY_PS1 that contains notify.ps1 path.'
    _usage
  fi
elif [ "$OS_TYPE" != "Darwin" ]; then
  echo "unsupported platform: $OS_TYPE"
  exit 1
fi

if [ "$OS_TYPE" = "Darwin" ]; then
  DEFAULT_TITLE="Notification"
else
  DEFAULT_TITLE="WSL Notification"
fi
DEFAULT_MESSAGE="Task Completed"

PIPE_INPUT=""

if [ -p /dev/stdin ]; then
  PIPE_INPUT=$(cat)
fi

if [ -n "$PIPE_INPUT" ]; then
  # Usage: echo "Done" | notify "title text"
  TITLE="${1:-$DEFAULT_TITLE}"
  MESSAGE="$PIPE_INPUT"
else
  # Usage: notify "title text" "message"
  # Usage: notify "message"
  if [ $# -eq 1 ]; then
    TITLE="$DEFAULT_TITLE"
    MESSAGE="$1"
  else
    TITLE="${1:-$DEFAULT_TITLE}"
    MESSAGE="${2:-$DEFAULT_MESSAGE}"
  fi
fi

CLEAN_MESSAGE=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g')
CLEAN_TITLE=$(echo "$TITLE" | sed 's/"/\\"/g')

echo "$CLEAN_TITLE : $CLEAN_MESSAGE" >> /tmp/notify-log.txt

if [ "$OS_TYPE" = "Darwin" ]; then
  osascript -e "display notification \"${CLEAN_MESSAGE}\" with title \"${CLEAN_TITLE}\" sound name \"default\""
else
  ${POWERSHELL_EXE} -Sta -NoProfile -WindowStyle Hidden -ExecutionPolicy RemoteSigned -File ${NOTIFY_PS1} -Title "${CLEAN_TITLE}" -Prompt "${CLEAN_MESSAGE}"
fi
